suite: otlp loadbalancing (trace-ID routing)
release:
  name: test
  namespace: observability
templates:
  - edge-config.yaml
  - downstream-service-headless.yaml
tests:
  - it: renders headless Service when otlpLoadBalancing is true
    set:
      edge.enabled: true
      edge.queueBackend: "otlp"
      edge.otlpLoadBalancing: true
      downstream.enabled: true
    template: downstream-service-headless.yaml
    documentIndex: 0
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: test-otel-collector-downstream-headless
      - equal:
          path: spec.clusterIP
          value: None
      - equal:
          path: spec.ports[0].port
          value: 4317

  - it: edge config uses loadbalancing exporter with traceID routing for traces
    set:
      edge.enabled: true
      edge.queueBackend: "otlp"
      edge.otlpLoadBalancing: true
      downstream.enabled: true
    template: edge-config.yaml
    documentIndex: 0
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: "loadbalancing:"
      - matchRegex:
          path: data["config.yaml"]
          pattern: "routing_key:\\s*traceID"
      - matchRegex:
          path: data["config.yaml"]
          pattern: "headless.*svc\\.cluster\\.local"
      - matchRegex:
          path: data["config.yaml"]
          pattern: "\\[loadbalancing\\]"
      - matchRegex:
          path: data["config.yaml"]
          pattern: otlphttp

  - it: does not render headless Service when otlpLoadBalancing is false
    set:
      edge.enabled: true
      edge.queueBackend: "otlp"
      edge.otlpLoadBalancing: false
      downstream.enabled: true
    template: downstream-service-headless.yaml
    asserts:
      - hasDocuments:
          count: 0
  - it: does not render edge ConfigMap when edge is disabled
    set:
      edge.enabled: false
      downstream.enabled: true
    template: edge-config.yaml
    asserts:
      - hasDocuments:
          count: 0
